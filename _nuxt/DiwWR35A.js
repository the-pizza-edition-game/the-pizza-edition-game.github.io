import{q as m}from"./DipR4v5c.js";const q="pizagame-cache",D=1,c="game-cache-status",g="game-resources-v1",x=()=>{const f=m(null),l=m(!1),i=async()=>f.value?f.value:new Promise((r,e)=>{if(typeof window>"u"||!window.indexedDB){e(new Error("IndexedDB not supported"));return}const t=indexedDB.open(q,D);t.onerror=()=>e(t.error),t.onsuccess=()=>{f.value=t.result,l.value=!0,r(t.result)},t.onupgradeneeded=o=>{const n=o.target.result;if(!n.objectStoreNames.contains(c)){const s=n.createObjectStore(c,{keyPath:"slug"});s.createIndex("status","status",{unique:!1}),s.createIndex("cachedAt","cachedAt",{unique:!1})}}}),w=async r=>{const e=await i();return new Promise((t,o)=>{const a=e.transaction([c],"readonly").objectStore(c).get(r);a.onsuccess=()=>t(a.result||null),a.onerror=()=>o(a.error)})},d=async r=>{const e=await i();return new Promise((t,o)=>{const a=e.transaction([c],"readwrite").objectStore(c).put(r);a.onsuccess=()=>t(),a.onerror=()=>o(a.error)})},p=async r=>{try{return(await w(r))?.status==="cached"}catch(e){return console.error("Error checking cache status:",e),!1}},E=async r=>{try{return(await w(r))?.status||"none"}catch(e){return console.error("Error getting cache status:",e),"none"}},v=async(r,e,t,o)=>{if(typeof window>"u"||!("serviceWorker"in navigator))throw new Error("Service Worker not supported");try{await d({gameId:o||e,slug:e,title:t,url:r,cachedAt:Date.now(),status:"caching"});const s=(await navigator.serviceWorker.ready).active;if(!s)throw new Error("No active service worker");return new Promise((a,y)=>{const u=new MessageChannel;u.port1.onmessage=async h=>{h.data.success?(await d({gameId:o||e,slug:e,title:t,url:r,cachedAt:Date.now(),status:"cached",size:h.data.size}),a(!0)):(await d({gameId:o||e,slug:e,title:t,url:r,cachedAt:Date.now(),status:"failed",error:h.data.error||"Unknown error"}),y(new Error(h.data.error||"Failed to cache game")))},s.postMessage({type:"CACHE_GAME",gameUrl:r,gameId:o||e,slug:e},[u.port2]),setTimeout(async()=>{await d({gameId:o||e,slug:e,title:t,url:r,cachedAt:Date.now(),status:"failed",error:"Cache timeout"}),y(new Error("Cache timeout"))},3e4)})}catch(n){throw console.error("Error caching game:",n),await d({gameId:o||e,slug:e,title:t,url:r,cachedAt:Date.now(),status:"failed",error:n instanceof Error?n.message:"Unknown error"}),n}},b=async r=>{if(!(typeof window>"u"))try{const e=await w(r);if(!e)return;await(await caches.open(g)).delete(e.url);const o=await i();return new Promise((n,s)=>{const u=o.transaction([c],"readwrite").objectStore(c).delete(r);u.onsuccess=()=>n(),u.onerror=()=>s(u.error)})}catch(e){throw console.error("Error removing cache:",e),e}},A=async()=>{const r=await i();return new Promise((e,t)=>{const a=r.transaction([c],"readonly").objectStore(c).index("status").getAll("cached");a.onsuccess=()=>e(a.result||[]),a.onerror=()=>t(a.error)})},C=async()=>{if(typeof navigator>"u"||!navigator.storage?.estimate)return null;try{const r=await navigator.storage.estimate(),e=r.usage||0,t=r.quota||0,o=t>0?e/t*100:0;return{usage:e,quota:t,percentUsed:o}}catch(r){return console.error("Error getting storage quota:",r),null}},S=async()=>{if(!(typeof window>"u"))try{await caches.delete(g);const r=await i();return new Promise((e,t)=>{const s=r.transaction([c],"readwrite").objectStore(c).clear();s.onsuccess=()=>e(),s.onerror=()=>t(s.error)})}catch(r){throw console.error("Error clearing all caches:",r),r}};return l.value||i().catch(console.error),{initDB:i,isGameCached:p,getCacheStatus:E,getCacheInfo:w,cacheGame:v,uncacheGame:b,getCachedGames:A,getStorageQuota:C,clearAllCaches:S,isInitialized:l}};export{x as u};
