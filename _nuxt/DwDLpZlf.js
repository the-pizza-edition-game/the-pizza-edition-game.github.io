import{q as G}from"./CwGGYkXo.js";const B="pizagame-cache",I=2,c="game-cache-status",p="game-resources-v2";function C(d,f,u){try{const l=new URL(d),w=new URL(f);return l.origin===w.origin?`/__cached__/${u}${l.pathname}${l.search}`:d}catch{return d}}const k=()=>{const d=G(null),f=G(!1),u=async()=>d.value?d.value:new Promise((t,e)=>{if(typeof window>"u"||!window.indexedDB){e(new Error("IndexedDB not supported"));return}const r=indexedDB.open(B,I);r.onerror=()=>e(r.error),r.onsuccess=()=>{d.value=r.result,f.value=!0,t(r.result)},r.onupgradeneeded=o=>{const s=o.target.result;s.objectStoreNames.contains(c)&&s.deleteObjectStore(c);const n=s.createObjectStore(c,{keyPath:"slug"});n.createIndex("status","status",{unique:!1}),n.createIndex("cachedAt","cachedAt",{unique:!1})}}),l=async t=>{const e=await u();return new Promise((r,o)=>{const a=e.transaction([c],"readonly").objectStore(c).get(t);a.onsuccess=()=>r(a.result||null),a.onerror=()=>o(a.error)})},w=async t=>{const e=await u();return new Promise((r,o)=>{const a=e.transaction([c],"readwrite").objectStore(c).put(t);a.onsuccess=()=>r(),a.onerror=()=>o(a.error)})},$=async t=>{try{return(await l(t))?.status==="cached"}catch(e){return console.error("[useGameCache] Error checking cache status:",e),!1}},b=async t=>{try{return(await l(t))?.status||"none"}catch(e){return console.error("[useGameCache] Error getting cache status:",e),"none"}},v=async(t,e,r,o="html5",s,n)=>{if(typeof window>"u")throw new Error("Cannot cache game on server side");try{await w({gameId:s||e,slug:e,title:r,url:t,cachedAt:Date.now(),status:"caching"}),console.log(`[useGameCache] Requesting cache for ${e}...`);const a=await fetch(`/api/game-cache/${e}`,{method:"POST"});if(!a.ok){const h=await a.text();throw new Error(`Failed to cache game: ${h}`)}const m=await a.json();if(!m.success||!m.manifest)throw new Error(m.error||"Failed to get cache manifest");const i=m.manifest;console.log(`[useGameCache] Got manifest with ${i.resources.length} resources`);const A=await caches.open(p),U=i.resources.length;let g=0,_=0;for(const h of i.resources)try{const y=h.r2Key.split("/").pop(),E=await fetch(`/api/game-resource/${e}/resources/${y}`);if(E.ok){const D=C(h.originalUrl,i.gameUrl,e),j=new URL(D,window.location.origin).href;await A.put(j,E.clone()),g++,_+=h.size,n&&n({currentResource:h.originalUrl,downloaded:g,total:U,bytesDownloaded:_,totalBytes:i.totalSize})}else console.warn(`[useGameCache] Failed to download: ${h.originalUrl}`)}catch(y){console.warn(`[useGameCache] Error caching resource: ${h.originalUrl}`,y)}return await w({gameId:s||e,slug:e,title:r,url:t,cachedAt:Date.now(),status:"cached",size:i.totalSize,manifest:i}),console.log(`[useGameCache] Cache complete: ${g}/${U} resources`),!0}catch(a){throw console.error("[useGameCache] Error caching game:",a),await w({gameId:s||e,slug:e,title:r,url:t,cachedAt:Date.now(),status:"failed",error:a instanceof Error?a.message:"Unknown error"}),a}},S=async t=>{if(!(typeof window>"u"))try{const e=await l(t);if(!e)return;const r=await caches.open(p);if(e.manifest)for(const s of e.manifest.resources){const n=C(s.originalUrl,e.manifest.gameUrl,t),a=new URL(n,window.location.origin).href;await r.delete(a)}else await r.delete(e.url);const o=await u();return new Promise((s,n)=>{const i=o.transaction([c],"readwrite").objectStore(c).delete(t);i.onsuccess=()=>s(),i.onerror=()=>n(i.error)})}catch(e){throw console.error("[useGameCache] Error removing cache:",e),e}},P=async()=>{const t=await u();return new Promise((e,r)=>{const a=t.transaction([c],"readonly").objectStore(c).index("status").getAll("cached");a.onsuccess=()=>e(a.result||[]),a.onerror=()=>r(a.error)})},q=async()=>{if(!(typeof window>"u"))try{await caches.delete(p);const t=await u();return new Promise((e,r)=>{const n=t.transaction([c],"readwrite").objectStore(c).clear();n.onsuccess=()=>e(),n.onerror=()=>r(n.error)})}catch(t){throw console.error("[useGameCache] Error clearing all caches:",t),t}},R=async()=>{if(typeof navigator>"u"||!navigator.storage?.estimate)return null;try{const t=await navigator.storage.estimate(),e=t.usage||0,r=t.quota||0,o=r>0?e/r*100:0;return{usage:e,quota:r,percentUsed:o}}catch(t){return console.error("[useGameCache] Error getting storage quota:",t),null}},x=async t=>{const e=await l(t);if(!e?.manifest)return null;if("entryPath"in e.manifest&&e.manifest.entryPath)return`/__cached__/${t}${e.manifest.entryPath}`;const r=e.manifest.resources.find(o=>o.originalUrl===e.manifest.gameUrl||o.originalUrl.endsWith("/index.html")||o.originalUrl.endsWith("/"));if(r)return C(r.originalUrl,e.manifest.gameUrl,t);try{const o=new URL(e.manifest.gameUrl);return`/__cached__/${t}${o.pathname}`}catch{return`/__cached__/${t}/index.html`}};return f.value||u().catch(console.error),{initDB:u,isGameCached:$,getCacheStatus:b,getCacheInfo:l,cacheGame:v,uncacheGame:S,getCachedGames:P,clearAllCaches:q,getStorageQuota:R,getCachedGameUrl:x,isInitialized:f}};export{k as u};
